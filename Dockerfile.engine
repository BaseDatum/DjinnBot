# Stage 0: signal-cli native binary builder (arm64 only — amd64 uses pre-built release)
FROM ghcr.io/graalvm/graalvm-community:25 AS signal-cli-builder

ARG TARGETARCH
ARG SIGNAL_CLI_VERSION=0.13.24

# On arm64 there is no pre-built native binary, so compile from source.
# On amd64 this stage produces a dummy file (the real binary is downloaded later).
RUN if [ "$TARGETARCH" = "arm64" ]; then \
      microdnf install -y git findutils tar gzip gcc glibc-devel zlib-devel && \
      git clone --depth 1 --branch v${SIGNAL_CLI_VERSION} \
        https://github.com/AsamK/signal-cli.git /build && \
      cd /build && ./gradlew --no-daemon nativeCompile ; \
    else \
      mkdir -p /build/build/native/nativeCompile && \
      touch /build/build/native/nativeCompile/signal-cli ; \
    fi

# Stage 1: TypeScript Builder
FROM node:22-slim AS ts-builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    ca-certificates \
    build-essential \
    cmake \
    g++ \
    python3 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy root workspace files for dependency resolution
COPY package.json package-lock.json tsconfig.base.json ./
COPY packages/core/package.json ./packages/core/
COPY packages/slack/package.json ./packages/slack/
COPY packages/signal/package.json ./packages/signal/
COPY packages/code-graph/package.json ./packages/code-graph/

# Install production deps only (includes workspace linking)
RUN npm install --omit=dev

# Install Bun 1.3.6 (required for QMDR - 1.3.7+ has sqlite-vec segfault)
RUN curl -fsSL https://bun.sh/install | bash -s "bun-v1.3.6"
ENV PATH="/root/.bun/bin:${PATH}"

# Install QMDR via Bun (remote-first qmd fork - uses cloud APIs instead of local GGUF)
# Bun install properly resolves sqlite-vec native dependencies
# Note: Must use Bun ≤1.3.6 due to sqlite-vec segfault in 1.3.7+
RUN bun install -g github:uf-hy/qmdr && \
    ln -sf /root/.bun/bin/qmd /usr/local/bin/qmd && \
    echo "QMDR installed via Bun"

# Patch QMDR to fix embedding model mismatch when using remote embeddings
# When QMD_EMBED_PROVIDER=openai, the local GGUF model name was being passed to the
# remote API, causing "Model openai/embeddinggemma does not exist" errors.
# This patch removes the 'model' parameter from remote.embed() calls, allowing
# the remoteLLM's configured embedModel to be used instead.
RUN sed -i 's/await remote.embed(formattedText, { model, isQuery })/await remote.embed(formattedText, { isQuery })/' /root/.bun/install/global/node_modules/qmdr/src/store.ts

# Patch QMDR embed command to support QMD_EMBED_PROVIDER=openai
# The embed command only checked for 'siliconflow', not 'openai', causing:
# - Indexing: local embeddinggemma (768 dims)
# - Searching: OpenAI text-embedding-3-small (1536 dims)
# This dimension mismatch breaks vector search. The patch adds openai support.
RUN sed -i "s/process.env.QMD_EMBED_PROVIDER === 'siliconflow'/process.env.QMD_EMBED_PROVIDER === 'siliconflow' || process.env.QMD_EMBED_PROVIDER === 'openai'/" /root/.bun/install/global/node_modules/qmdr/src/qmd.ts && \
    sed -i "s/const remoteModel = process.env.QMD_SILICONFLOW_EMBED_MODEL || 'Qwen\/Qwen3-Embedding-8B'/const remoteModel = process.env.QMD_EMBED_PROVIDER === 'openai' ? (process.env.QMD_OPENAI_EMBED_MODEL || 'text-embedding-3-small') : (process.env.QMD_SILICONFLOW_EMBED_MODEL || 'Qwen\/Qwen3-Embedding-8B')/" /root/.bun/install/global/node_modules/qmdr/src/qmd.ts && \
    sed -i "s/Using remote embedding: SiliconFlow/Using remote embedding:/" /root/.bun/install/global/node_modules/qmdr/src/qmd.ts

# Create qmd config directory (env vars take precedence, but this allows .env file)
RUN mkdir -p /root/.config/qmd

# Install tsx locally so `node --import tsx` resolves from /app/node_modules
RUN npm install tsx

# QMDR environment (enables sqlite extensions)
ENV QMD_ALLOW_SQLITE_EXTENSIONS=1

# Make clawvault CLI globally available to agents
RUN ln -sf /app/node_modules/.bin/clawvault /usr/local/bin/clawvault

# Copy built code from ts-builder
COPY --from=ts-builder /build/packages/core/dist ./packages/core/dist
COPY --from=ts-builder /build/packages/slack/dist ./packages/slack/dist
COPY --from=ts-builder /build/packages/signal/dist ./packages/signal/dist
COPY --from=ts-builder /build/packages/code-graph/dist ./packages/code-graph/dist

# Create directories for runtime data
RUN mkdir -p /data /data/vaults /data/signal/data /data/signal/attachments /pipelines /agents

# VERIFY ALL TOOLS
RUN echo "=== Core Languages ===" && \
    python3 --version && \
    node --version && \
    go version && \
    rustc --version && \
    cargo --version && \
    echo "=== Package Managers ===" && \
    pip3 --version && \
    npm --version && \  
    bun --version && \
    echo "=== Version Control ===" && \
    git --version && \
    gh --version && \
    echo "=== Modern CLI Tools ===" && \
    rg --version && \
    fd --version && \
    bat --version && \
    fzf --version && \
    delta --version && \
    eza --version && \
    dust --version && \
    yq --version && \
    jq --version && \
    docker --version && \
    docker compose version && \
    juicefs version && \
    signal-cli --version && \
    echo "=== Network Tools ===" && \
    curl --version | head -1 && \
    wget --version | head -1 && \
    ssh -V 2>&1 && \
    rsync --version | head -1 && \
    echo "=== Utilities ===" && \
    test -x /usr/local/bin/qmd && echo "qmd (QMDR): OK" && \
    sqlite3 --version && \
    convert --version | head -1 && \
    echo "=== All tools verified! ==="

# Version injected at build time by CI (git tag)
ARG BUILD_VERSION=dev
ENV DJINNBOT_BUILD_VERSION=${BUILD_VERSION}

ENV NODE_ENV=production
ENV REDIS_URL=redis://localhost:6379
ENV DATABASE_PATH=/data/djinnbot.db
ENV DATA_DIR=/data
ENV VAULTS_DIR=/data/vaults
ENV PIPELINES_DIR=/pipelines
ENV AGENTS_DIR=/agents

# Allow git to work with directories owned by other users (Docker volumes).
# Use --system (/etc/gitconfig) instead of --global (~/.gitconfig) because
# the engine runs with HOME=/data, so --global would write to /data/.gitconfig
# which is on the shared volume and not guaranteed to have the setting.
RUN git config --system --add safe.directory '*'

CMD ["node", "packages/core/dist/main.js"]
